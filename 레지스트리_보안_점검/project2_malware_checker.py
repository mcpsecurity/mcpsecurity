from mcp.server.fastmcp import FastMCP
import psutil
import json
import os
import re
import hashlib
import subprocess
from datetime import datetime
from typing import Dict, List, Any, Tuple
import requests  # Claude API í˜¸ì¶œìš© ë¼ì´ë¸ŒëŸ¬ë¦¬


# MCP ì„œë²„ ìƒì„± (127.0.0.1:5003)
mcp = FastMCP(name="malware_detection_checker", host="127.0.0.1", port=5003, timeout=30)

# ì•…ì„±ì½”ë“œ ì˜ì‹¬ í”„ë¡œì„¸ìŠ¤ íƒì§€ìš© íŒ¨í„´ ë° ì„ê³„ê°’ ì •ì˜
SUSPICIOUS_PATTERNS = {
    "suspicious_names": [
        r".*\.tmp\.exe$", r".*\.scr$", r".*\.pif$", r".*\.bat\.exe$",
        r"^[a-f0-9]{8,}\.exe$", r"^temp\d+\.exe$", r"^[0-9]+\.exe$",
        r"^[a-zA-Z]{1,3}\.exe$", r".*\d{8,}\.exe$"
    ],
    "legitimate_system_processes": [
        "svchost.exe", "winlogon.exe", "explorer.exe", "lsass.exe",
        "csrss.exe", "wininit.exe", "services.exe", "smss.exe"
    ],
    "suspicious_paths": [
        r"C:\\Windows\\Temp\\.*",
        r"C:\\Users\\.*\\AppData\\Local\\Temp\\.*",
        r"C:\\Temp\\.*",
        r"C:\\ProgramData\\.*\.exe$",
        r".*\\Desktop\\.*\.exe$",
        r".*\\Downloads\\.*\.exe$",
        r".*\\Public\\.*\.exe$"
    ],
    "high_resource_thresholds": {
        "cpu_threshold": 80.0,                      # CPU ì‚¬ìš©ë¥  ì„ê³„ê°’ (80%)
        "memory_threshold": 500 * 1024 * 1024,     # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì„ê³„ê°’ (500MB)
        "io_threshold": 100 * 1024 * 1024           # I/O ì„ê³„ê°’ (100MB/s)
    },
    "suspicious_ports": [1433, 3389, 4444, 5555, 6666, 7777, 8888, 9999, 31337, 12345]  # ì˜ì‹¬ í¬íŠ¸ ë¦¬ìŠ¤íŠ¸
}

# íŒŒì¼ ì“°ê¸° í•¨ìˆ˜
def write_file(filename: str, content: str) -> None:
    try:
        with open(filename, 'w', encoding='utf-8') as f:
            f.write(content)
    except Exception as e:
        print(f"íŒŒì¼ ì“°ê¸° ì˜¤ë¥˜: {e}")

# í”„ë¡œì„¸ìŠ¤ í–‰ë™ ë¶„ì„ í•¨ìˆ˜
def analyze_process_behavior(process: psutil.Process) -> Dict[str, Any]:
    try:
        # í”„ë¡œì„¸ìŠ¤ ê¸°ë³¸ ì •ë³´ ì´ˆê¸°í™”
        info = {
            "pid": process.pid,
            "name": process.name(),
            "exe": "N/A",
            "cmdline": "N/A",
            "cwd": "N/A",
            "create_time": datetime.fromtimestamp(process.create_time()).strftime("%Y-%m-%d %H:%M:%S"),
            "status": process.status(),
            "username": "N/A"
        }
        
        # ì‹¤í–‰ íŒŒì¼ ê²½ë¡œ ê°€ì ¸ì˜¤ê¸° (ê¶Œí•œ ì˜ˆì™¸ ì²˜ë¦¬)
        try:
            info["exe"] = process.exe()
        except (psutil.AccessDenied, psutil.NoSuchProcess):
            pass
            
        # ëª…ë ¹í–‰ ì¸ì ê°€ì ¸ì˜¤ê¸°
        try:
            info["cmdline"] = " ".join(process.cmdline())
        except (psutil.AccessDenied, psutil.NoSuchProcess):
            pass
            
        # í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
        try:
            info["cwd"] = process.cwd()
        except (psutil.AccessDenied, psutil.NoSuchProcess):
            pass
            
        # í”„ë¡œì„¸ìŠ¤ ì†Œìœ ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        try:
            info["username"] = process.username()
        except (psutil.AccessDenied, psutil.NoSuchProcess):
            pass
        
        # ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ ìˆ˜ì§‘
        try:
            cpu_percent = process.cpu_percent(interval=1)
            memory_info = process.memory_info()
            io_counters = process.io_counters() if hasattr(process, 'io_counters') else None
            
            info.update({
                "cpu_percent": cpu_percent,
                "memory_rss": memory_info.rss,
                "memory_vms": memory_info.vms,
                "io_read_bytes": io_counters.read_bytes if io_counters else 0,
                "io_write_bytes": io_counters.write_bytes if io_counters else 0
            })
        except (psutil.AccessDenied, psutil.NoSuchProcess):
            info.update({
                "cpu_percent": 0,
                "memory_rss": 0,
                "memory_vms": 0,
                "io_read_bytes": 0,
                "io_write_bytes": 0
            })
        
        # ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì •ë³´ ìˆ˜ì§‘
        try:
            connections = process.connections()
            info["network_connections"] = len(connections)
            info["listening_ports"] = [conn.laddr.port for conn in connections if conn.status == 'LISTEN']
        except (psutil.AccessDenied, psutil.NoSuchProcess):
            info["network_connections"] = 0
            info["listening_ports"] = []
        
        return info
        
    except (psutil.NoSuchProcess, psutil.AccessDenied) as e:
        return {"error": str(e), "pid": process.pid}

# ì˜ì‹¬ë„ ì ìˆ˜ ê³„ì‚° í•¨ìˆ˜ (0~100)
def calculate_suspicion_score(process_info: Dict[str, Any]) -> Tuple[int, List[str]]:
    score = 0
    reasons = []
    
    if "error" in process_info:
        return 0, ["í”„ë¡œì„¸ìŠ¤ ì •ë³´ ì ‘ê·¼ ë¶ˆê°€"]
    
    process_name = process_info.get("name", "").lower()
    process_exe = process_info.get("exe", "").lower()
    
    # 1. ì˜ì‹¬ìŠ¤ëŸ¬ìš´ í”„ë¡œì„¸ìŠ¤ ì´ë¦„ íŒ¨í„´ ê²€ì‚¬
    for pattern in SUSPICIOUS_PATTERNS["suspicious_names"]:
        if re.match(pattern, process_name, re.IGNORECASE):
            score += 20
            reasons.append(f"ì˜ì‹¬ìŠ¤ëŸ¬ìš´ í”„ë¡œì„¸ìŠ¤ ì´ë¦„ íŒ¨í„´: {process_name}")
            break
    
    # 2. ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ì‹¤í–‰ ê²½ë¡œ ê²€ì‚¬
    for pattern in SUSPICIOUS_PATTERNS["suspicious_paths"]:
        if re.match(pattern, process_exe, re.IGNORECASE):
            score += 25
            reasons.append(f"ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ì‹¤í–‰ ê²½ë¡œ: {process_exe}")
            break
    
    # 3. ì‹œìŠ¤í…œ í”„ë¡œì„¸ìŠ¤ ìœ„ì¥ ì—¬ë¶€ ê²€ì‚¬
    if process_name in SUSPICIOUS_PATTERNS["legitimate_system_processes"]:
        if not process_exe.lower().startswith("c:\\windows\\system32\\"):
            score += 30
            reasons.append(f"ì‹œìŠ¤í…œ í”„ë¡œì„¸ìŠ¤ ìœ„ì¥ ì˜ì‹¬: {process_name}")
    
    # 4. ë¹„ì •ìƒì  ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ ê²€ì‚¬
    cpu_percent = process_info.get("cpu_percent", 0)
    memory_usage = process_info.get("memory_rss", 0)
    
    if cpu_percent > SUSPICIOUS_PATTERNS["high_resource_thresholds"]["cpu_threshold"]:
        score += 15
        reasons.append(f"ë¹„ì •ìƒì ìœ¼ë¡œ ë†’ì€ CPU ì‚¬ìš©ëŸ‰: {cpu_percent:.1f}%")
    
    if memory_usage > SUSPICIOUS_PATTERNS["high_resource_thresholds"]["memory_threshold"]:
        score += 10
        reasons.append(f"ë¹„ì •ìƒì ìœ¼ë¡œ ë†’ì€ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: {memory_usage // (1024*1024)}MB")
    
    # 5. ë„¤íŠ¸ì›Œí¬ ì—°ê²° ë° í¬íŠ¸ ê²€ì‚¬
    network_connections = process_info.get("network_connections", 0)
    listening_ports = process_info.get("listening_ports", [])
    
    if network_connections > 20:
        score += 10
        reasons.append(f"ê³¼ë„í•œ ë„¤íŠ¸ì›Œí¬ ì—°ê²°: {network_connections}ê°œ")
    
    for port in listening_ports:
        if port in SUSPICIOUS_PATTERNS["suspicious_ports"]:
            score += 20
            reasons.append(f"ì˜ì‹¬ìŠ¤ëŸ¬ìš´ í¬íŠ¸ ì‚¬ìš©: {port}")
    
    # 6. ëª…ë ¹í–‰ ì¸ì ë‚´ ì˜ì‹¬ ë‹¨ì–´ ê²€ì‚¬
    cmdline = process_info.get("cmdline", "").lower()
    suspicious_args = ["powershell", "cmd", "wget", "curl", "certutil", "bitsadmin"]
    for arg in suspicious_args:
        if arg in cmdline:
            score += 5
            reasons.append(f"ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ëª…ë ¹í–‰ ì¸ì: {arg}")
    
    return min(score, 100), reasons

# MCP ë„êµ¬: íŒŒì¼ ì“°ê¸° (ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í•¨ìˆ˜ì§€ë§Œ ì½”ë“œ íë¦„ìƒ í¬í•¨)
def write_file(filename: str, content: str) -> None:
    try:
        with open(filename, 'w', encoding='utf-8') as f:
            f.write(content)
    except Exception as e:
        print(f"íŒŒì¼ ì“°ê¸° ì˜¤ë¥˜: {e}")

# Claude API í˜¸ì¶œ í•¨ìˆ˜
def call_claude_api(prompt: str) -> str:
    api_url = "https://api.anthropic.com/v1/complete"
    api_key = os.getenv("CLAUDE_API_KEY")
    if not api_key:
        return "âŒ CLAUDE_API_KEY í™˜ê²½ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."

    headers = {
        "x-api-key": api_key,
        "Content-Type": "application/json"
    }
    data = {
        "model": "claude-v1",
        "prompt": f"\n\nHuman: {prompt}\n\nAssistant:",
        "max_tokens_to_sample": 200,
        "temperature": 0.5,
        "stop_sequences": ["\n\nHuman:"]
    }

    try:
        response = requests.post(api_url, headers=headers, json=data, timeout=15)
        response.raise_for_status()
        result = response.json()
        return result.get("completion", "ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.")
    except Exception as e:
        return f"âŒ Claude API í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {str(e)}"

# MCP ë„êµ¬: ì˜ì‹¬ í”„ë¡œì„¸ìŠ¤ ìŠ¤ìº”
@mcp.tool()
def scan_suspicious_processes() -> str:
    try:
        scan_time = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        
        all_processes = []
        suspicious_processes = []
        
        for proc in psutil.process_iter(['pid', 'name']):
            try:
                process_info = analyze_process_behavior(proc)
                if "error" not in process_info:
                    score, reasons = calculate_suspicion_score(process_info)
                    
                    process_data = {
                        "process_info": process_info,
                        "suspicion_score": score,
                        "reasons": reasons
                    }
                    
                    all_processes.append(process_data)
                    
                    if score >= 30:  # ì˜ì‹¬ë„ 30 ì´ìƒì¸ ê²½ìš°
                        suspicious_processes.append(process_data)
                        
            except (psutil.NoSuchProcess, psutil.AccessDenied):
                continue
        
        # ë³´ê³ ì„œ ìƒì„±
        report = {
            "scan_time": scan_time,
            "total_processes": len(all_processes),
            "suspicious_count": len(suspicious_processes),
            "high_risk_count": len([p for p in suspicious_processes if p["suspicion_score"] >= 70]),
            "medium_risk_count": len([p for p in suspicious_processes if 50 <= p["suspicion_score"] < 70]),
            "low_risk_count": len([p for p in suspicious_processes if 30 <= p["suspicion_score"] < 50]),
            "suspicious_processes": suspicious_processes
        }
        
        # ê²°ê³¼ JSON íŒŒì¼ ì €ì¥
        report_filename = f"malware_scan_report_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
        write_file(report_filename, json.dumps(report, indent=2, ensure_ascii=False))
        
        # ìš”ì•½ ë³´ê³ ì„œ ë¬¸ìì—´ ìƒì„±
        summary = f"""
=== ì•…ì„±ì½”ë“œ ì˜ì‹¬ í”„ë¡œì„¸ìŠ¤ íƒì§€ ë³´ê³ ì„œ ===
ìŠ¤ìº” ì‹œê°„: {scan_time}
ì´ í”„ë¡œì„¸ìŠ¤ ìˆ˜: {report['total_processes']}ê°œ
ì˜ì‹¬ í”„ë¡œì„¸ìŠ¤ ìˆ˜: {report['suspicious_count']}ê°œ

ğŸš¨ ìœ„í—˜ë„ë³„ ë¶„ë¥˜:
- ë†’ìŒ (70ì  ì´ìƒ): {report['high_risk_count']}ê°œ
- ì¤‘ê°„ (50-69ì ): {report['medium_risk_count']}ê°œ  
- ë‚®ìŒ (30-49ì ): {report['low_risk_count']}ê°œ

ğŸ” ì˜ì‹¬ í”„ë¡œì„¸ìŠ¤ ìƒì„¸:
"""
        
        for proc_data in suspicious_processes[:10]:  # ìƒìœ„ 10ê°œë§Œ í‘œì‹œ
            proc_info = proc_data["process_info"]
            score = proc_data["suspicion_score"]
            reasons = proc_data["reasons"]
            
            risk_level = "ë†’ìŒ" if score >= 70 else "ì¤‘ê°„" if score >= 50 else "ë‚®ìŒ"
            
            summary += f"""
[{risk_level}] {proc_info['name']} (PID: {proc_info['pid']}) - ì˜ì‹¬ë„: {score}ì 
- ì‹¤í–‰ íŒŒì¼: {proc_info['exe']}
- ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: {proc_info['memory_rss'] // (1024*1024)}MB
- CPU ì‚¬ìš©ëŸ‰: {proc_info['cpu_percent']}%
- ì˜ì‹¬ ì‚¬ìœ : {', '.join(reasons[:3])}
"""
        
        if len(suspicious_processes) > 10:
            summary += f"\n... ì™¸ {len(suspicious_processes) - 10}ê°œ ë” (ìƒì„¸ ë³´ê³ ì„œ ì°¸ì¡°)"
        
        summary += f"\n\nğŸ“‹ ìƒì„¸ ë³´ê³ ì„œ: {report_filename}"
        
        # â€” ì—¬ê¸°ì„œ claudeì—ê²Œ ìš”ì•½ ë¦¬í¬íŠ¸ í‰ê°€ ìš”ì²­ í›„ ê²°ê³¼ ë°›ê¸°
        claude_prompt = f"ë‹¤ìŒì€ ì•…ì„±ì½”ë“œ ì˜ì‹¬ í”„ë¡œì„¸ìŠ¤ ìŠ¤ìº” ìš”ì•½ì…ë‹ˆë‹¤. ì˜ì‹¬ í”„ë¡œì„¸ìŠ¤ë“¤ì´ ì‹¤ì œ ì•…ì„± ê°€ëŠ¥ì„±ì´ ì–¼ë§ˆë‚˜ ë˜ëŠ”ì§€, ì¶”ê°€ë¡œ ì¶”ì²œí•  ë§Œí•œ ì¡°ì¹˜ê°€ ìˆìœ¼ë©´ ì•Œë ¤ì£¼ì„¸ìš”:\n{summary}"
        claude_response = call_claude_api(claude_prompt)
        
        summary += f"\n\nğŸ¤– Claude ë¶„ì„:\n{claude_response}"
        
        return summary
        
    except Exception as e:
        return f"í”„ë¡œì„¸ìŠ¤ ìŠ¤ìº” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"

# MCP ë„êµ¬: ì˜ì‹¬ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ (ì‹ ì¤‘íˆ ì‚¬ìš©)
@mcp.tool()
def kill_suspicious_process(pid: int) -> str:
    try:
        process = psutil.Process(pid)
        process_name = process.name()
        
        # ì‹œìŠ¤í…œ ì¤‘ìš” í”„ë¡œì„¸ìŠ¤ ë¦¬ìŠ¤íŠ¸
        critical_processes = [
            "winlogon.exe", "csrss.exe", "services.exe", "lsass.exe",
            "wininit.exe", "smss.exe", "dwm.exe", "explorer.exe"
        ]
        
        if process_name.lower() in [p.lower() for p in critical_processes]:
            return f"âŒ ì¤‘ìš”í•œ ì‹œìŠ¤í…œ í”„ë¡œì„¸ìŠ¤ëŠ” ì¢…ë£Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {process_name}"
        
        # í”„ë¡œì„¸ìŠ¤ ì •ìƒ ì¢…ë£Œ ì‹œë„
        process.terminate()
        
        # 3ì´ˆ ëŒ€ê¸° í›„ ê°•ì œ ì¢…ë£Œ ì‹œë„
        try:
            process.wait(timeout=3)
        except psutil.TimeoutExpired:
            process.kill()
            process.wait()
        
        return f"âœ… í”„ë¡œì„¸ìŠ¤ê°€ ì„±ê³µì ìœ¼ë¡œ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤: {process_name} (PID: {pid})"
        
    except psutil.NoSuchProcess:
        return f"âŒ í”„ë¡œì„¸ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: PID {pid}"
    except psutil.AccessDenied:
        return f"âŒ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤: PID {pid} (ê´€ë¦¬ì ê¶Œí•œ í•„ìš”)"
    except Exception as e:
        return f"âŒ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"

# MCP ë„êµ¬: íŠ¹ì • í”„ë¡œì„¸ìŠ¤ ìƒì„¸ ì •ë³´ ì¡°íšŒ
@mcp.tool()
def get_process_details(pid: int) -> str:
    try:
        process = psutil.Process(pid)
        process_info = analyze_process_behavior(process)
        
        if "error" in process_info:
            return f"âŒ í”„ë¡œì„¸ìŠ¤ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {process_info['error']}"
        
        score, reasons = calculate_suspicion_score(process_info)
        
        # ìƒì„¸ ì •ë³´ ì¶œë ¥ ë¬¸ìì—´ ìƒì„±
        details = f"""
=== í”„ë¡œì„¸ìŠ¤ ìƒì„¸ ì •ë³´ ===
ğŸ“‹ ê¸°ë³¸ ì •ë³´:
- í”„ë¡œì„¸ìŠ¤ ID: {process_info['pid']}
- ì´ë¦„: {process_info['name']}
- ì‹¤í–‰ íŒŒì¼: {process_info['exe']}
- ìƒíƒœ: {process_info['status']}
- ì‚¬ìš©ì: {process_info['username']}
- ìƒì„± ì‹œê°„: {process_info['create_time']}
- ì‘ì—… ë””ë ‰í† ë¦¬: {process_info['cwd']}

ğŸ’» ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰:
- CPU ì‚¬ìš©ë¥ : {process_info['cpu_percent']}%
- ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: {process_info['memory_rss'] // (1024*1024)}MB (RSS)
- ê°€ìƒ ë©”ëª¨ë¦¬: {process_info['memory_vms'] // (1024*1024)}MB (VMS)
- I/O ì½ê¸°: {process_info['io_read_bytes'] // (1024*1024)}MB
- I/O ì“°ê¸°: {process_info['io_write_bytes'] // (1024*1024)}MB

ğŸŒ ë„¤íŠ¸ì›Œí¬ ì •ë³´:
- ì—°ê²° ìˆ˜: {process_info['network_connections']}ê°œ
- ìˆ˜ì‹  í¬íŠ¸: {process_info['listening_ports']}

ğŸ” ëª…ë ¹í–‰ ì¸ì:
{process_info['cmdline']}

ğŸš¨ ì˜ì‹¬ë„ ë¶„ì„:
- ì˜ì‹¬ë„ ì ìˆ˜: {score}/100
- ìœ„í—˜ë„: {"ë†’ìŒ" if score >= 70 else "ì¤‘ê°„" if score >= 50 else "ë‚®ìŒ" if score >= 30 else "ì •ìƒ"}
- ì˜ì‹¬ ì‚¬ìœ : {', '.join(reasons) if reasons else 'ì—†ìŒ'}
"""
        
        return details
        
    except psutil.NoSuchProcess:
        return f"âŒ í”„ë¡œì„¸ìŠ¤ë¥¼ ìŠ¤ìº”í•˜ì§€ ëª»í•˜ì˜€ìŠµë‹ˆë‹¤."

# ì„œë²„ ì‹¤í–‰ë¶€
if __name__ == "__main__":
    
    try:
        print("Windows ë³´ì•ˆ ì ê²€ MCP ì„œë²„ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...")
        print("ì„œë²„ ì£¼ì†Œ: http://127.0.0.1:5003")

        # MCP ë„êµ¬ ì„œë²„ ì‹œì‘
        mcp.run()
    except Exception as e:
        print(f"ì„œë²„ ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}")
        input("Press Enter to exit...")